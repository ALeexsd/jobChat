# Архитектура проекта

## Обзор

Корпоративный мессенджер построен на современном стеке технологий с использованием микросервисной архитектуры.

## Технологический стек

### Backend
- **FastAPI** - современный веб-фреймворк для Python
- **SQLAlchemy 2.0** - ORM для работы с БД
- **PostgreSQL** - реляционная база данных
- **Alembic** - миграции БД
- **WebSockets** - реалтайм коммуникация
- **JWT** - аутентификация и авторизация
- **Pydantic** - валидация данных

### Frontend
- **Vue.js 3** - прогрессивный JavaScript фреймворк
- **Composition API** - современный подход к Vue компонентам
- **Pinia** - state management
- **Vue Router** - маршрутизация
- **Axios** - HTTP клиент
- **SCSS** - препроцессор CSS

### Infrastructure
- **Docker** - контейнеризация
- **Docker Compose** - оркестрация контейнеров

## Архитектура Backend

### Слои приложения

```
┌─────────────────────────────────────┐
│         API Layer (FastAPI)         │
│  - REST endpoints                   │
│  - WebSocket endpoints              │
│  - Request/Response handling        │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│       Business Logic Layer          │
│  - Services                         │
│  - Business rules                   │
│  - Data processing                  │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│         Data Access Layer           │
│  - SQLAlchemy models                │
│  - Database queries                 │
│  - Transactions                     │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│          PostgreSQL Database        │
└─────────────────────────────────────┘
```

### Модули Backend

#### 1. Core (`app/core/`)
- `config.py` - конфигурация приложения
- `database.py` - подключение к БД
- `security.py` - аутентификация и авторизация

#### 2. Models (`app/models/`)
SQLAlchemy модели для всех сущностей:
- User - пользователи
- Chat, ChatMember - чаты и участники
- Message, MessageReaction, MessageAttachment - сообщения
- Task, TaskAssignee, TaskComment, SubTask - задачи
- Route, RouteLocation, RouteAssignee - маршруты
- Note - заметки
- Vacation - отпуска
- Notification - уведомления

#### 3. Schemas (`app/schemas/`)
Pydantic схемы для валидации:
- Request schemas - входящие данные
- Response schemas - исходящие данные

#### 4. API (`app/api/`)
REST endpoints:
- `/auth` - аутентификация
- `/users` - пользователи
- `/chats` - чаты
- `/messages` - сообщения
- `/tasks` - задачи
- `/routes` - маршруты
- `/notes` - заметки
- `/vacations` - отпуска
- `/notifications` - уведомления

#### 5. WebSocket (`app/websocket/`)
- Connection manager
- Real-time message handling
- Typing indicators
- Status updates

## Архитектура Frontend

### Структура приложения

```
┌─────────────────────────────────────┐
│           Vue Router                │
│  - Route guards                     │
│  - Navigation                       │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│            Views                    │
│  - Page components                  │
│  - Layout components                │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│          Components                 │
│  - Reusable UI components           │
│  - Business components              │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│        Pinia Stores                 │
│  - State management                 │
│  - Actions                          │
│  - Getters                          │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│          Services                   │
│  - API service (Axios)              │
│  - WebSocket service                │
└─────────────────────────────────────┘
```

### Stores (Pinia)

#### 1. Auth Store
- Управление аутентификацией
- Хранение токенов
- Информация о текущем пользователе

#### 2. Chat Store
- Список чатов
- Сообщения
- Отправка сообщений

#### 3. Task Store
- Список задач
- CRUD операции
- Комментарии и подзадачи

### Services

#### 1. API Service
- HTTP клиент на базе Axios
- Interceptors для токенов
- Автоматическое обновление токенов

#### 2. WebSocket Service
- Подключение к WebSocket
- Обработка входящих сообщений
- Отправка событий

## База данных

### Схема БД

#### Users
- Хранение пользователей
- Роли и права доступа
- Статусы присутствия

#### Chats & Messages
- Личные и групповые чаты
- Сообщения с вложениями
- Реакции на сообщения

#### Tasks
- Задачи с приоритетами
- Назначение исполнителей
- Комментарии и подзадачи

#### Routes
- Маршруты с локациями
- Назначение сотрудников
- Статусы выполнения

#### Notes
- Личные заметки
- Заметки о пользователях
- Категории и теги

#### Vacations
- Запросы на отпуск
- Утверждение/отклонение
- Календарь отпусков

#### Notifications
- Централизованные уведомления
- Типы уведомлений
- Статус прочтения

### Индексы

Основные индексы для оптимизации:
- `users.username` - уникальный индекс
- `messages.chat_id` - для быстрого поиска сообщений
- `messages.created_at` - для сортировки
- `tasks.status` - для фильтрации
- `notifications.user_id, is_read` - для непрочитанных

## Безопасность

### Аутентификация
- JWT токены (access + refresh)
- Хэширование паролей (bcrypt)
- Защита WebSocket соединений

### Авторизация
- Роли пользователей (Admin, Manager, Employee)
- Проверка прав доступа на уровне API
- Ограничение доступа к чатам

### Валидация
- Pydantic схемы на backend
- Проверка типов файлов
- Ограничение размера файлов

## Масштабируемость

### Горизонтальное масштабирование
- Stateless API
- Shared PostgreSQL
- Redis для сессий (опционально)

### Вертикальное масштабирование
- Оптимизация запросов
- Индексы БД
- Кэширование

## Мониторинг и логирование

### Логи
- Структурированное логирование
- Уровни логов (DEBUG, INFO, WARNING, ERROR)
- Ротация логов

### Метрики
- Время ответа API
- Количество активных соединений
- Использование ресурсов

## Развертывание

### Development
```bash
docker-compose up -d
```

### Production
- Использование production-ready WSGI сервера (Gunicorn)
- Nginx как reverse proxy
- SSL/TLS сертификаты
- Автоматические бэкапы БД

## Будущие улучшения

1. **Кэширование**
   - Redis для кэширования
   - Кэширование часто запрашиваемых данных

2. **Поиск**
   - Elasticsearch для полнотекстового поиска
   - Индексация сообщений

3. **Файловое хранилище**
   - S3-совместимое хранилище
   - CDN для статики

4. **Уведомления**
   - Push-уведомления
   - Email уведомления
   - SMS уведомления

5. **Аналитика**
   - Статистика использования
   - Дашборды
   - Отчеты
