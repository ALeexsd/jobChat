# üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç WebSocket

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

–ò–∑–º–µ–Ω–µ–Ω —Å–ø–æ—Å–æ–± —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ WebSocket endpoint:
- –í–º–µ—Å—Ç–æ `add_websocket_route` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@app.websocket`
- –¢–æ–∫–µ–Ω –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ `websocket.query_params`
- Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫

## üß™ –¢–ï–°–¢ –°–ï–ô–ß–ê–°

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –ù–∞–∂–º–∏—Ç–µ **Ctrl+Shift+R** (–∂–µ—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
3. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ **admin / admin123**
4. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

**–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:**
```
üîå WebSocket connect() called
üîó Connecting to WebSocket: ws://localhost:8000/ws?token=...
‚úÖ WebSocket onopen fired - connection established!
üì® WebSocket message received: connected
```

**–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –æ—à–∏–±–∫–∞ 1006:**
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å (—Å–º. –Ω–∏–∂–µ)

### –®–∞–≥ 3: –¢–µ—Å—Ç —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞

–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```javascript
const token = localStorage.getItem('access_token')
console.log('Token:', token ? 'OK' : 'MISSING')

const ws = new WebSocket(`ws://localhost:8000/ws?token=${token}`)

ws.onopen = () => {
    console.log('‚úÖ WEBSOCKET OPENED!')
    console.log('State:', ws.readyState)
}

ws.onmessage = (e) => {
    console.log('üì® MESSAGE:', e.data)
}

ws.onerror = (e) => {
    console.error('‚ùå ERROR:', e)
}

ws.onclose = (e) => {
    console.log('üîå CLOSED:', e.code, e.reason)
}
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ backend –ª–æ–≥–∏

–û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
docker logs chat_backend -f
```

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
```
INFO: WebSocket connection attempt with token: eyJhbGciOiJIUzI1NiIs...
INFO: User 1 connected. Total connections: 1
INFO: Added user 1 to chat X
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –ï—Å–ª–∏ WebSocket –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:

**–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:**
```
‚úÖ WEBSOCKET OPENED!
State: 1
üì® MESSAGE: {"type":"connected","user_id":1,...}
```

**–í backend –ª–æ–≥–∞—Ö:**
```
INFO: WebSocket connection attempt...
INFO: User 1 connected...
```

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:**
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–º. –Ω–∏–∂–µ)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
3. –í—Å–µ –≥–æ—Ç–æ–≤–æ! üéâ

### ‚ùå –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –æ—à–∏–±–∫–∞ 1006:

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ:**
```bash
# –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker-compose down
docker-compose up -d

# –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫—É–Ω–¥
# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞
```

**–ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ:**
```bash
# –°–æ–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏
docker logs chat_backend --tail 200 > backend_full.txt
docker logs chat_frontend --tail 100 > frontend_full.txt

# –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –æ–±–∞ —Ñ–∞–π–ª–∞
```

## üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–ï—Å–ª–∏ WebSocket –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–≤–∞ –æ–∫–Ω–∞
- –û–∫–Ω–æ 1: user1 / password123
- –û–∫–Ω–æ 2: user2 / password123

### 2. –í –æ–∫–Ω–µ 1:
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ /chats
- –ù–∞–π–¥–∏—Ç–µ —á–∞—Ç —Å user2
- –û—Ç–ø—Ä–∞–≤—å—Ç–µ: "–¢–µ—Å—Ç WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç!"

### 3. –í –æ–∫–Ω–µ 2:
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ /chats
- **–ù–ï –û–¢–ö–†–´–í–ê–ô–¢–ï** —á–∞—Ç

**–î–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- ‚úÖ –ß–∞—Ç –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª—Å—è –Ω–∞–≤–µ—Ä—Ö
- ‚úÖ –ü–æ—è–≤–∏–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–¢–µ—Å—Ç WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç!"
- ‚úÖ –ü–æ—è–≤–∏–ª—Å—è –∫—Ä–∞—Å–Ω—ã–π –±–µ–π–¥–∂ "1"

**–í –∫–æ–Ω—Å–æ–ª–∏ –æ–∫–Ω–∞ 2:**
```
üì® WebSocket message received: new_message
üì® New message in chat list: {...}
üìä Unread count for chat X: 1
‚¨ÜÔ∏è Moved chat X to top
```

## üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

**–û–ë–ù–û–í–ò–¢–ï –°–¢–†–ê–ù–ò–¶–£ (Ctrl+Shift+R) –ò –ü–†–û–í–ï–†–¨–¢–ï –ö–û–ù–°–û–õ–¨!**

–°–æ–æ–±—â–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è - –ø–æ–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏
- ‚ùå –û—à–∏–±–∫–∞ 1006 - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
- ‚ö†Ô∏è –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ - –ø–æ–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏

---

**–î–∞—Ç–∞:** 23.11.2025 12:55
**–°—Ç–∞—Ç—É—Å:** –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
