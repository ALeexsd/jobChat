# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è WebSocket –∏ UI

## üîß –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ –≤—Å–µ –µ–≥–æ —á–∞—Ç—ã –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω fallback –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–æ–¥–ø–∏—Å–∫–æ–π –Ω–∞ —Å–æ–±—ã—Ç–∏—è

**–ö–æ–¥:**
```javascript
// Frontend - –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if (!websocket.isConnected()) {
  websocket.connect()
  await new Promise((resolve) => {
    if (websocket.isConnected()) {
      resolve()
    } else {
      const unsubscribe = websocket.on('connected', () => {
        unsubscribe()
        resolve()
      })
      setTimeout(resolve, 3000)
    }
  })
}
```

```python
# Backend - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —á–∞—Ç—ã
async with async_session_maker() as db:
    result = await db.execute(
        select(ChatMember.chat_id).where(ChatMember.user_id == user_id)
    )
    chat_ids = [row[0] for row in result.all()]
    
    for chat_id in chat_ids:
        manager.add_user_to_chat(user_id, chat_id)
```

---

### 2. ‚úÖ –°—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—á–µ—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å—á–µ—Ç—á–∏–∫–∞
- –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)

**–ö–æ–¥:**
```javascript
// –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
if (data.message.sender_id !== authStore.user?.id) {
  const currentCount = unreadMessages.value[data.chat_id] || 0
  unreadMessages.value[data.chat_id] = currentCount + 1
  console.log(`üìä Unread count for chat ${data.chat_id}: ${unreadMessages.value[data.chat_id]}`)
}
```

---

### 3. ‚úÖ –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞–≤–µ—Ä—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ß–∞—Ç—ã —Å –Ω–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –Ω–µ –ø–µ—Ä–µ–º–µ—â–∞–ª–∏—Å—å –Ω–∞–≤–µ—Ä—Ö —Å–ø–∏—Å–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —á–∞—Ç–∞ –Ω–∞–≤–µ—Ä—Ö –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è last_message –≤ —á–∞—Ç–µ
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–¥:**
```javascript
// –ü–µ—Ä–µ–º–µ—â–∞–µ–º —á–∞—Ç –Ω–∞–≤–µ—Ä—Ö
const index = chats.value.indexOf(chat)
if (index > 0) {
  chats.value.splice(index, 1)
  chats.value.unshift(chat)
  console.log(`‚¨ÜÔ∏è Moved chat ${data.chat_id} to top`)
}
```

---

### 4. ‚úÖ –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—è–≤–ª—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `opacity-100` –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
- –ö–Ω–æ–ø–∫–∞ —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ

**–ö–æ–¥:**
```vue
<button
  @click.prevent="confirmDeleteChat(chat)"
  class="hidden lg:block absolute top-4 right-4 p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors opacity-100"
  title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç"
>
  <TrashIcon class="w-5 h-5" />
</button>
```

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –¢–µ—Å—Ç 1: WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É (admin / admin123)
3. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```
   üîå Connecting to WebSocket from ChatsView...
   ‚úÖ WebSocket connected in ChatsView
   üì° Subscribing to WebSocket events in ChatsView
   ```

### –¢–µ—Å—Ç 2: –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å—á–µ—Ç—á–∏–∫
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –¥–≤—É—Ö –æ–∫–Ω–∞—Ö:
   - –û–∫–Ω–æ 1: user1 / password123
   - –û–∫–Ω–æ 2: user2 / password123
2. –í –æ–∫–Ω–µ 1 –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ user2
3. –í –æ–∫–Ω–µ 2 –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ –ß–∞—Ç –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª—Å—è –Ω–∞–≤–µ—Ä—Ö
   - ‚úÖ –ü–æ—è–≤–∏–ª–æ—Å—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   - ‚úÖ –ü–æ—è–≤–∏–ª—Å—è –∫—Ä–∞—Å–Ω—ã–π –±–µ–π–¥–∂ —Å "1"
4. –í –∫–æ–Ω—Å–æ–ª–∏ –æ–∫–Ω–∞ 2 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏:
   ```
   üì® New message in chat list: {...}
   üìä Unread count for chat X: 1
   ‚¨ÜÔ∏è Moved chat X to top
   ```

### –¢–µ—Å—Ç 3: –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞
1. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
2. –°—á–µ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –∏—Å—á–µ–∑–Ω—É—Ç—å
3. –í –∫–æ–Ω—Å–æ–ª–∏:
   ```
   ‚úÖ Messages read: {...}
   üìä Reset unread count for chat X
   ```

### –¢–µ—Å—Ç 4: –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
1. –û—Ç–∫—Ä–æ–π—Ç–µ /chats –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ (—à–∏—Ä–∏–Ω–∞ > 1024px)
2. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —á–∞—Ç
3. –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–∫–æ—Ä–∑–∏–Ω–∞) –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–¥–Ω–∞ –≤—Å–µ–≥–¥–∞
4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ
6. –ß–∞—Ç –¥–æ–ª–∂–µ–Ω –∏—Å—á–µ–∑–Ω—É—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞

### –¢–µ—Å—Ç 5: –°–≤–∞–π–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
1. –û—Ç–∫—Ä–æ–π—Ç–µ /chats –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º (–∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ –æ–∫–Ω–æ)
2. –°–≤–∞–π–ø–Ω–∏—Ç–µ —á–∞—Ç –≤–ª–µ–≤–æ
3. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
4. –°–≤–∞–π–ø–Ω–∏—Ç–µ –¥–∞–ª—å—à–µ (> 60px)
5. –ü–æ—è–≤–∏—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞: WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
websocket.isConnected()  // –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ backend –ª–æ–≥–∏:
   ```bash
   docker logs chat_backend --tail 50 | grep WebSocket
   ```
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env —Ñ–∞–π–ª:
   ```bash
   cat frontend/.env
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: VITE_WS_URL=ws://localhost:8000
   ```
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
   ```bash
   docker restart chat_backend chat_frontend
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –°—á–µ—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
console.log(unreadMessages.value)
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (—Å–º. –≤—ã—à–µ)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:
   ```
   üì® New message in chat list: {...}
   üìä Unread count for chat X: Y
   ```
3. –ï—Å–ª–∏ –ª–æ–≥–æ–≤ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ backend:
   ```bash
   docker logs chat_backend --tail 50 | grep "new_message"
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –ß–∞—Ç—ã –Ω–µ –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è –Ω–∞–≤–µ—Ä—Ö
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
‚¨ÜÔ∏è Moved chat X to top
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç:
   ```
   üì® New message in chat list: {...}
   ```
3. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ —á–∞—Ç –Ω–µ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è - –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+R)

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –≤–∏–¥–Ω–∞
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)
2. –ù–∞–π–¥–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CSS –∫–ª–∞—Å—Å—ã

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —à–∏—Ä–∏–Ω–∞ –æ–∫–Ω–∞ > 1024px
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª–∞—Å—Å `opacity-100` –Ω–∞ –∫–Ω–æ–ø–∫–µ
3. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞

---

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### Frontend (–∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞)
```
üîå Connecting to WebSocket from ChatsView...
‚úÖ WebSocket connected in ChatsView
üì° Subscribing to WebSocket events in ChatsView
üì® New message in chat list: {...}
üìä Unread count for chat X: Y
‚¨ÜÔ∏è Moved chat X to top
‚úÖ Messages read: {...}
üìä Reset unread count for chat X
üîå Unsubscribing from WebSocket events in ChatsView
```

### Backend (docker logs)
```bash
docker logs chat_backend --tail 50
```

–ò—â–∏—Ç–µ:
```
INFO:     User X connected. Total connections: Y
INFO:     Added user X to chat Y
INFO:     Sending new_message notification for chat X to all members except Y
INFO:     Chat X has Y members
INFO:     Sent notification to user Z
```

---

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ frontend
```bash
docker exec chat_frontend npm run build
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```bash
docker restart chat_backend
docker restart chat_frontend
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
docker-compose ps
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
# Backend
docker logs chat_backend --tail 50 -f

# Frontend
docker logs chat_frontend --tail 50 -f
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
1. ‚úÖ WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. ‚úÖ –°—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
3. ‚úÖ –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞–≤–µ—Ä—Ö
4. ‚úÖ –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ

–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000 –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏!

---

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 23.11.2025 02:56
