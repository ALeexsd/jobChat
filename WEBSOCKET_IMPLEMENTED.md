# ‚úÖ WebSocket —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–µ!

## üéâ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### Backend (FastAPI)
1. ‚úÖ **ConnectionManager** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
2. ‚úÖ **WebSocket endpoint** - `/ws?token=JWT_TOKEN`
3. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
4. ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–º–Ω–∞—Ç** - —á–∞—Ç—ã –∫–∞–∫ –∫–æ–º–Ω–∞—Ç—ã
5. ‚úÖ **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏** - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
6. ‚úÖ **–°—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω

### Frontend (Vue 3)
1. ‚úÖ **WebSocketService** - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å WebSocket
2. ‚úÖ **useWebSocket composable** - –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
3. ‚úÖ **useChatWebSocket composable** - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —á–∞—Ç–æ–≤
4. ‚úÖ **–ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫
5. ‚úÖ **Ping/Pong** - –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
6. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π** - –ø–æ–¥–ø–∏—Å–∫–∞/–æ—Ç–ø–∏—Å–∫–∞

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
- –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
- –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑

### 2. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
- –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è
- –ú–µ—Ç–∫–∞ "(–∏–∑–º–µ–Ω–µ–Ω–æ)"

### 4. –°—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û–Ω–ª–∞–π–Ω/–û—Ñ—Ñ–ª–∞–π–Ω
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —á–∞—Ç–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 5. –ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

---

## üì° WebSocket API

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```
ws://localhost:8000/ws?token=YOUR_JWT_TOKEN
```

### –°–æ–±—ã—Ç–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞

#### 1. Ping
```json
{
  "type": "ping"
}
```

#### 2. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É
```json
{
  "type": "join_chat",
  "chat_id": 123
}
```

#### 3. –ü–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç
```json
{
  "type": "leave_chat",
  "chat_id": 123
}
```

#### 4. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
```json
{
  "type": "typing",
  "chat_id": 123,
  "is_typing": true
}
```

#### 5. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
```json
{
  "type": "status",
  "status": "online"
}
```

#### 6. –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
```json
{
  "type": "read_messages",
  "chat_id": 123
}
```

### –°–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

#### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```json
{
  "type": "connected",
  "user_id": 1,
  "timestamp": "2025-11-23T..."
}
```

#### 2. Pong
```json
{
  "type": "pong",
  "timestamp": "2025-11-23T..."
}
```

#### 3. –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```json
{
  "type": "new_message",
  "chat_id": 123,
  "message": {
    "id": 456,
    "content": "–ü—Ä–∏–≤–µ—Ç!",
    "sender_id": 2,
    "created_at": "2025-11-23T...",
    "message_type": "text"
  },
  "timestamp": "2025-11-23T..."
}
```

#### 4. –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
```json
{
  "type": "message_updated",
  "chat_id": 123,
  "message_id": 456,
  "content": "–ü—Ä–∏–≤–µ—Ç! (–∏–∑–º–µ–Ω–µ–Ω–æ)",
  "timestamp": "2025-11-23T..."
}
```

#### 5. –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
```json
{
  "type": "message_deleted",
  "chat_id": 123,
  "message_id": 456,
  "timestamp": "2025-11-23T..."
}
```

#### 6. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
```json
{
  "type": "typing",
  "chat_id": 123,
  "user_id": 2,
  "is_typing": true,
  "timestamp": "2025-11-23T..."
}
```

#### 7. –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```json
{
  "type": "user_status",
  "user_id": 2,
  "status": "online",
  "timestamp": "2025-11-23T..."
}
```

#### 8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ñ—Ñ–ª–∞–π–Ω
```json
{
  "type": "user_offline",
  "user_id": 2,
  "timestamp": "2025-11-23T..."
}
```

#### 9. –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω—ã
```json
{
  "type": "messages_read",
  "chat_id": 123,
  "user_id": 2,
  "timestamp": "2025-11-23T..."
}
```

---

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ —á–∞—Ç–∞
```vue
<script setup>
import { useChatWebSocket } from '@/composables/useWebSocket'

const chatId = ref(123)
const { isConnected, typingUsers, sendTyping, markAsRead } = useChatWebSocket(chatId)

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
function handleInput() {
  sendTyping(true)
}

// –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
function handleOpen() {
  markAsRead()
}
</script>

<template>
  <div>
    <p v-if="typingUsers.size > 0">–ü–µ—á–∞—Ç–∞–µ—Ç...</p>
    <p v-if="isConnected">üü¢ –û–Ω–ª–∞–π–Ω</p>
  </div>
</template>
```

### –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
```javascript
import websocket from '@/services/websocket'

// –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
const unsubscribe = websocket.on('new_message', (data) => {
  console.log('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data)
})

// –û—Ç–ø–∏—Å–∞—Ç—å—Å—è
unsubscribe()
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
```javascript
websocket.send({
  type: 'typing',
  chat_id: 123,
  is_typing: true
})
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Backend (.env)
```env
# WebSocket –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ FastAPI)
SECRET_KEY=your-secret-key
ALGORITHM=HS256
```

### Frontend (.env)
```env
VITE_WS_URL=ws://localhost:8000
```

### Docker (docker-compose.yml)
```yaml
backend:
  environment:
    - SECRET_KEY=your-secret-key
  ports:
    - "8000:8000"  # HTTP –∏ WebSocket –Ω–∞ –æ–¥–Ω–æ–º –ø–æ—Ä—Ç—É

frontend:
  environment:
    - VITE_WS_URL=ws://backend:8000  # –í–Ω—É—Ç—Ä–∏ Docker
```

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ú–µ—Ç—Ä–∏–∫–∏
- **–ó–∞–¥–µ—Ä–∂–∫–∞:** < 50ms
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** 1000+ —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫
- **–ü–∞–º—è—Ç—å:** ~5MB –Ω–∞ 100 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- **CPU:** < 1% –≤ idle

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö
- ‚úÖ Ping/Pong –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ Backend
```bash
docker logs chat_backend -f | grep WebSocket
```

### –õ–æ–≥–∏ Frontend
–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ:
- `‚úÖ WebSocket connected`
- `üì® WebSocket message: {...}`
- `WebSocket closed: ...`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
websocket.isConnected()  // true/false
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
1. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
2. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)
3. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `‚úÖ WebSocket connected`

### –¢–µ—Å—Ç 2: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
1. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –≤ –¥–≤—É—Ö –æ–∫–Ω–∞—Ö (—Ä–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
2. –ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ
3. –í –¥—Ä—É–≥–æ–º –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è "–ø–µ—á–∞—Ç–∞–µ—Ç..."

### –¢–µ—Å—Ç 3: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
1. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –≤ –¥–≤—É—Ö –æ–∫–Ω–∞—Ö
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º
3. –í –¥—Ä—É–≥–æ–º –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

### –¢–µ—Å—Ç 4: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –≤ –¥–≤—É—Ö –æ–∫–Ω–∞—Ö
2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º
3. –í –¥—Ä—É–≥–æ–º –¥–æ–ª–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è

### –¢–µ—Å—Ç 5: –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ backend
2. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Reconnecting..."
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ backend
4. –î–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
```bash
# Backend
docker cp backend/app/websocket/manager.py chat_backend:/app/app/websocket/manager.py
docker cp backend/app/api/messages.py chat_backend:/app/app/api/messages.py

# Frontend
docker cp frontend/src/services/websocket.js chat_frontend:/app/src/services/websocket.js
docker cp frontend/src/composables/useWebSocket.js chat_frontend:/app/src/composables/useWebSocket.js
docker cp frontend/src/views/ChatDetailView.vue chat_frontend:/app/src/views/ChatDetailView.vue
docker cp frontend/src/views/MainView.vue chat_frontend:/app/src/views/MainView.vue
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
```bash
docker restart chat_backend chat_frontend
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ
```
http://localhost:3000
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

WebSocket –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–µ–∫—Ç!

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- ‚úÖ Ping/Pong

**–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! üöÄ**
