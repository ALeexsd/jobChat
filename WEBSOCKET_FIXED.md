# ‚úÖ WebSocket –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

## üîß –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
WebSocket –Ω–µ –º–æ–≥ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è, –æ—à–∏–±–∫–∞ **1006** (connection closed abnormally).

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä `token` –Ω–µ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω –∫–∞–∫ Query parameter –≤ FastAPI.

### –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `Query` –∏–∑ FastAPI –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏:

```python
from fastapi import WebSocket, WebSocketDisconnect, Query
from typing import Optional

async def websocket_endpoint(websocket: WebSocket, token: Optional[str] = Query(None)):
    logger.info(f"WebSocket connection attempt with token: {token[:20] if token else 'None'}...")
    # ...
```

–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

## üß™ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –ù–∞–∂–º–∏—Ç–µ **Ctrl+Shift+R** (–∂–µ—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞)
3. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ **admin / admin123**
4. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

**–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:**
```
üîå WebSocket connect() called
üîó Connecting to WebSocket: ws://localhost:8000/ws?token=...
‚úÖ WebSocket onopen fired - connection established!
üì® WebSocket message received: connected {...}
```

**–ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –æ—à–∏–±–∫–∞:**
- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–µ –ª–æ–≥–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ: `docker logs chat_backend --tail 50`
- –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –æ–±–∞ –ª–æ–≥–∞

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ backend –ª–æ–≥–∏

–û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
docker logs chat_backend -f
```

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
```
INFO: WebSocket connection attempt with token: eyJhbGciOiJIUzI1NiIs...
INFO: User X connected. Total connections: Y
INFO: Added user X to chat Z
```

## üéØ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–ï—Å–ª–∏ WebSocket –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ:

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–≤–∞ –æ–∫–Ω–∞
- –û–∫–Ω–æ 1: –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ **user1 / password123**
- –û–∫–Ω–æ 2: –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ **user2 / password123**
- –í –æ–±–æ–∏—Ö –æ–∫–Ω–∞—Ö –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)

### 2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –í –æ–∫–Ω–µ 1: –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ /chats
- –ù–∞–π–¥–∏—Ç–µ —á–∞—Ç —Å user2
- –û—Ç–ø—Ä–∞–≤—å—Ç–µ: **"–¢–µ—Å—Ç WebSocket –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"**

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–∫–Ω–æ 2
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ /chats
- **–ù–ï –û–¢–ö–†–´–í–ê–ô–¢–ï** —á–∞—Ç

**–î–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- ‚úÖ –ß–∞—Ç –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª—Å—è –Ω–∞–≤–µ—Ä—Ö
- ‚úÖ –ü–æ—è–≤–∏–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- ‚úÖ –ü–æ—è–≤–∏–ª—Å—è –∫—Ä–∞—Å–Ω—ã–π –±–µ–π–¥–∂ "1"

**–í –∫–æ–Ω—Å–æ–ª–∏:**
```
üì® WebSocket message received: new_message {...}
üì® New message in chat list: {...}
üìä Unread count for chat X: 1
‚¨ÜÔ∏è Moved chat X to top
```

## üìä Backend –ª–æ–≥–∏

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ backend –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
INFO: Sending new_message notification for chat X to all members except Y
INFO: Chat X has 2 members
INFO: Sent notification to user Z
```

## ‚úÖ –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! WebSocket –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç:
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- ‚úÖ –ß–∞—Ç—ã –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è –Ω–∞–≤–µ—Ä—Ö

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

## ‚ùå –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–í—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
# –õ–æ–≥–∏ backend
docker logs chat_backend --tail 100 > backend_logs.txt

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
# –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –æ–±–∞ —Ñ–∞–π–ª–∞
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

**–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (Ctrl+Shift+R) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å!**

–°–æ–æ–±—â–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è
- ‚ùå –í—Å–µ –µ—â–µ –æ—à–∏–±–∫–∞ (–ø—Ä–∏–ª–æ–∂–∏—Ç–µ –ª–æ–≥–∏)

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 23.11.2025 12:25
